<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerunds & Infinitives — Plataforma (50Q)</title>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --accent:#22d3ee; --accent2:#a78bfa; --ok:#16a34a; --bad:#dc2626; --warn:#f59e0b; --text:#e5e7eb; --chip:#1f2937; }
    html,body{ height:100%; }
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji"; margin:0; background:#0f172a; color:var(--text); font-size:13px; line-height:1.6; }
    .wrap{ max-width:1000px; margin:0 auto; padding:24px; }
    .title{ font-weight:800; font-size:1.6rem; letter-spacing:.3px; display:flex; align-items:center; gap:.6rem; }
    .title .chip{ font-size:.8rem; padding:.2rem .5rem; border-radius:999px; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#0a0a0a; font-weight:700; }
    .card{ background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); backdrop-filter: blur(6px); margin:14px 0; }
    .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
    @media (min-width:900px){ .grid{ grid-template-columns:1fr 1fr; } }
    .muted{ color:var(--muted); }
    .btn{ appearance:none; border:0; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; transition: .2s ease; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#0a0a0a; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn.secondary{ background:#1f2937; color:var(--text); border:1px solid rgba(255,255,255,.12); }
    .btn.warn{ background:linear-gradient(90deg,#fde047,#fb923c); color:#111827; }
    .kpi{ display:flex; gap:10px; flex-wrap:wrap; }
    .kpi .pill{ background:var(--chip); border:1px solid rgba(255,255,255,.07); padding:6px 10px; border-radius:999px; }
    .ok{ color:var(--ok); } .bad{ color:var(--bad); } .warn{ color:var(--warn); }
    .question{ margin-top:8px; font-weight:700; }
    .options{ margin-top:6px; display:grid; gap:6px; }
    .option{ background:#0b1221; border:1px solid rgba(255,255,255,.07); padding:8px 10px; border-radius:10px; display:flex; gap:8px; align-items:center; }
    .option input{ accent-color:#22d3ee; }
    .tag{ font-size:.72rem; font-weight:700; color:#0a0a0a; background:linear-gradient(90deg,#67e8f9,#c4b5fd); padding:.2rem .45rem; border-radius:999px; }
    .footer{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    /* ORDER (tap-to-build): pool + respuesta */
    .order-wrap{ display:flex; flex-direction:column; gap:10px; }
    .order-hint{ font-size:.75rem; color:var(--muted); }
    .order-areas{ display:flex; gap:10px; flex-wrap:wrap; }
    .order-pool, .order-answer{ flex:1 1 300px; min-height:56px; padding:8px; border-radius:12px; background:#0a1222; border:1px solid rgba(255,255,255,.08); display:flex; flex-wrap:wrap; gap:8px; align-items:flex-start; }
    .order-answer{ background:#0b1530; }
    .order-chip{ background:#0b1221; border:1px dashed rgba(255,255,255,.25); padding:8px 12px; border-radius:999px; display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none; }
    .ghost{ opacity:.5; }

    .correct{ outline:2px solid var(--ok); }
    .incorrect{ outline:2px solid var(--bad); }

    /* Focus guard (anti-tab-switch) */
    #focusGuard{ position:fixed; inset:0; background:rgba(2,6,23,.94); color:#e2e8f0; display:none; z-index:9999; align-items:center; justify-content:center; text-align:center; padding:24px; }
    #focusGuard .inner{ max-width:720px; }

    /* Prevent selection except inside .allow-select */
    body{ -webkit-user-select:none; -ms-user-select:none; user-select:none; }
    .allow-select, .allow-select *{ -webkit-user-select:text; user-select:text; }

    /* Dev tests container (hidden) */
    #dev-tests{ display:none; white-space:pre-wrap; background:#111827; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.08); }
  </style>
</head>
<body>
  <div id="focusGuard">
    <div class="inner">
      <h2 style="margin:0 0 .4rem 0; font-size:1.4rem;">Mantén el enfoque en la evaluación</h2>
      <p class="muted">Detectamos un cambio de pestaña o intento de interacción no permitida. Para continuar, vuelve a esta ventana y pulsa <strong>Reanudar</strong>. El tiempo (si está activo) se pausa automáticamente.</p>
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:center;">
        <button class="btn" id="resumeBtn">Reanudar</button>
        <button class="btn secondary" id="fsBtn">Pantalla completa</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="title">Gerunds & Infinitives <span class="chip">50Q</span></div>
    <p class="muted">Incluye 30 preguntas de opción múltiple y 20 de ordenar. Tipografía base: 13px. Seguridad activada (anti‑copiar, anti‑context menu, alerta por cambio de pestaña, bloqueo de PrintScreen cuando es posible, etc.).</p>

    <div class="card" id="startCard">
      <div class="grid">
        <div>
          <label class="muted" for="name">Tu nombre</label>
          <input id="name" class="allow-select" placeholder="Escribe tu nombre" style="width:100%; margin-top:6px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0b1221; color:var(--text);" />
        </div>
      </div>
      <div class="footer" style="margin-top:12px;">
        <button class="btn" id="startBtn">Iniciar</button>
        <button class="btn secondary" id="goFull">Pantalla completa</button>
        <span class="badge">Se seleccionarán <strong>25 preguntas aleatorias</strong>. Tienes <strong>4:00</strong> por pregunta.</span>
      </div>
    </div>

    <div id="quizRoot" style="display:none;">
      <div class="card">
        <div class="kpi">
          <span class="pill">Participante: <strong id="who">—</strong></span>
          <span class="pill">Progreso: <strong id="progress">0/25</strong></span>
          <span class="pill">Tiempo: <strong id="timer">04:00</strong></span>
          <span class="pill">Correctas: <strong id="okCount">0</strong></span>
          <span class="pill">Incorrectas: <strong id="badCount">0</strong></span>
        </div>
        <div class="footer" style="margin-top:10px;">
          <button class="btn secondary" id="prevQ">Anterior</button>
          <button class="btn" id="checkQ">Comprobar</button>
          <button class="btn secondary" id="nextQ">Siguiente</button>
          <button class="btn warn" id="exportBtn">Exportar CSV</button>
          <button class="btn secondary" id="resetBtn">Reiniciar</button>
        </div>
      </div>

      <div id="questions"></div>
    </div>

    <pre id="dev-tests"></pre>
  </div>

  <script>
// ─────────────────────────────────────────────────────────────────────────────
// Banco de preguntas (30 MCQ + 20 ORDER)
// ─────────────────────────────────────────────────────────────────────────────
const MCQ = [
  {id:1,type:"mcq",rule:"Gerund-after-preposition",question:"I’m interested ________ Japanese.",options:["to learn","in learning","for learn","in to learn"],answer:"B"},
  {id:2,type:"mcq",rule:"Gerund-after-preposition",question:"She apologized ________ late.",options:["to be","for being","for be","to being"],answer:"B"},
  {id:3,type:"mcq",rule:"Gerund-after-preposition",question:"They left without ________ goodbye.",options:["say","to say","saying","to saying"],answer:"C"},
  {id:4,type:"mcq",rule:"Gerund-as-subject",question:"________ every day reduces stress.",options:["To walk","Walk","Walking","Walks"],answer:"C"},
  {id:5,type:"mcq",rule:"Gerund-after-verb",question:"We enjoy ________ board games.",options:["to play","playing","play","to playing"],answer:"B"},
  {id:6,type:"mcq",rule:"Gerund-after-verb",question:"He avoided ________ too much sugar.",options:["eat","to eat","eating","to eating"],answer:"C"},
  {id:7,type:"mcq",rule:"Gerund-after-phrasal",question:"They ended up ________ a smaller car.",options:["to buy","buy","buying","to buying"],answer:"C"},
  {id:8,type:"mcq",rule:"Gerund-expression",question:"It’s no use ________ now.",options:["to complain","complaining","complain","to complaining"],answer:"B"},
  {id:9,type:"mcq",rule:"Gerund-expression",question:"He spent an hour ________ the report.",options:["to review","review","reviewing","to reviewing"],answer:"C"},
  {id:10,type:"mcq",rule:"Gerund-after-preposition",question:"She insisted on ________ the bill.",options:["pay","to pay","paying","to paying"],answer:"C"},
  {id:11,type:"mcq",rule:"Infinitive-after-verb",question:"I decided ________ the teacher.",options:["asking","to ask","ask","to asking"],answer:"B"},
  {id:12,type:"mcq",rule:"Infinitive-after-verb",question:"They hope ________ soon.",options:["to travel","travel","traveling","to traveling"],answer:"A"},
  {id:13,type:"mcq",rule:"Infinitive-after-verb",question:"She managed ________ on time.",options:["to finish","finish","finishing","to finishing"],answer:"A"},
  {id:14,type:"mcq",rule:"Infinitive-after-adjective",question:"It’s important ________ water.",options:["drinking","to drink","drink","to drinking"],answer:"B"},
  {id:15,type:"mcq",rule:"Infinitive-purpose",question:"He called ________ a question.",options:["to ask","asking","ask","to asking"],answer:"A"},
  {id:16,type:"mcq",rule:"Infinitive-purpose",question:"We left early ________ traffic.",options:["to avoid","avoiding","avoid","to avoiding"],answer:"A"},
  {id:17,type:"mcq",rule:"Infinitive-after-noun",question:"That’s a great way ________ vocabulary.",options:["learn","to learn","learning","to learning"],answer:"B"},
  {id:18,type:"mcq",rule:"Infinitive-after-wh",question:"I don’t know what ________ next.",options:["do","to do","doing","to doing"],answer:"B"},
  {id:19,type:"mcq",rule:"Infinitive-after-wh",question:"Show me how ________ the app.",options:["start","to start","starting","to starting"],answer:"B"},
  {id:20,type:"mcq",rule:"Infinitive-after-adjective",question:"She was happy ________ you again.",options:["to see","seeing","see","to seeing"],answer:"A"},
  {id:21,type:"mcq",rule:"Remember-gerund/inf",question:"Remember ________ your homework tonight.",options:["doing","to do","to doing","did"],answer:"B"},
  {id:22,type:"mcq",rule:"Remember-gerund/inf",question:"I remember ________ him last year.",options:["to meet","meeting","to meeting","meet"],answer:"B"},
  {id:23,type:"mcq",rule:"Stop-gerund/inf",question:"He stopped ________ because he was tired of it.",options:["to jog","jogging","to jogging","jog"],answer:"B"},
  {id:24,type:"mcq",rule:"Stop-gerund/inf",question:"He stopped ________ a coffee on the way.",options:["drinking","to drink","to drinking","drink"],answer:"B"},
  {id:25,type:"mcq",rule:"Try-gerund/inf",question:"Try ________ him; maybe he’ll answer.",options:["to call","calling","to calling","call"],answer:"B"},
  {id:26,type:"mcq",rule:"Try-gerund/inf",question:"Try ________ him before 9 a.m.; it might be hard.",options:["calling","to call","call","to calling"],answer:"B"},
  {id:27,type:"mcq",rule:"Forget-gerund/inf",question:"Don’t forget ________ the lights.",options:["turning off","to turn off","turn off","to turning off"],answer:"B"},
  {id:28,type:"mcq",rule:"Forget-gerund/inf",question:"I’ll never forget ________ the ocean for the first time.",options:["to see","seeing","to seeing","see"],answer:"B"},
  {id:29,type:"mcq",rule:"Regret-gerund/inf",question:"I regret ________ you the bad news, but it’s true.",options:["to tell","telling","to telling","told"],answer:"A"},
  {id:30,type:"mcq",rule:"Go-on-gerund/inf",question:"He went on ________ after the break (continued the same activity).",options:["to work","working","to working","work"],answer:"B"},
];
const ORDER = [
  {id:31,type:"order",rule:"Gerund-as-subject",correct_order:["Swimming","in the morning","is","refreshing"],shuffled:["refreshing","Swimming","is","in the morning"]},
  {id:32,type:"order",rule:"Gerund-after-preposition",correct_order:["She","is interested","in","learning","Korean"],shuffled:["Korean","in","learning","She","is interested"]},
  {id:33,type:"order",rule:"Gerund-after-verb",correct_order:["We","suggested","leaving","early"],shuffled:["suggested","We","early","leaving"]},
  {id:34,type:"order",rule:"Gerund-after-phrasal",correct_order:["They","ended up","buying","a scooter"],shuffled:["a scooter","They","buying","ended up"]},
  {id:35,type:"order",rule:"Gerund-expression",correct_order:["It’s","worth","reading","this article"],shuffled:["reading","this article","worth","It’s"]},
  {id:36,type:"order",rule:"Infinitive-after-verb",correct_order:["I","decided","to call","her"],shuffled:["to call","her","I","decided"]},
  {id:37,type:"order",rule:"Infinitive-after-adjective",correct_order:["It’s","easy","to learn","the basics"],shuffled:["the basics","to learn","It’s","easy"]},
  {id:38,type:"order",rule:"Infinitive-purpose",correct_order:["He","went","to the store","to buy","milk"],shuffled:["to buy","milk","He","to the store","went"]},
  {id:39,type:"order",rule:"Infinitive-after-noun",correct_order:["That’s","a good way","to practice","pronunciation"],shuffled:["to practice","pronunciation","That’s","a good way"]},
  {id:40,type:"order",rule:"Infinitive-after-wh",correct_order:["She","showed me","how","to start","the program"],shuffled:["the program","to start","how","She","showed me"]},
  {id:41,type:"order",rule:"Remember-to-do",correct_order:["Remember","to bring","your ID"],shuffled:["your ID","to bring","Remember"]},
  {id:42,type:"order",rule:"Remember-doing",correct_order:["I","remember","meeting","her","in 2022"],shuffled:["her","meeting","I","remember","in 2022"]},
  {id:43,type:"order",rule:"Stop-doing",correct_order:["He","stopped","smoking"],shuffled:["smoking","He","stopped"]},
  {id:44,type:"order",rule:"Stop-to-do",correct_order:["He","stopped","to drink","water"],shuffled:["stopped","He","water","to drink"]},
  {id:45,type:"order",rule:"Try-doing",correct_order:["Try","calling","him","first"],shuffled:["calling","first","Try","him"]},
  {id:46,type:"order",rule:"Try-to-do",correct_order:["Try","to call","him","before","noon"],shuffled:["before","to call","noon","Try","him"]},
  {id:47,type:"order",rule:"Forget-to-do",correct_order:["Don’t","forget","to turn off","the lights"],shuffled:["to turn off","forget","Don’t","the lights"]},
  {id:48,type:"order",rule:"Forget-doing",correct_order:["I’ll never","forget","visiting","Rome"],shuffled:["Rome","I’ll never","forget","visiting"]},
  {id:49,type:"order",rule:"Regret-to-do",correct_order:["I","regret","to tell","you","this"],shuffled:["to tell","you","this","I","regret"]},
  {id:50,type:"order",rule:"Go-on-doing",correct_order:["She","went on","studying","after","dinner"],shuffled:["went on","after","She","studying","dinner"]},
];

// ─────────────────────────────────────────────────────────────────────────────
// Utils
// ─────────────────────────────────────────────────────────────────────────────
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const shuffle = arr => arr.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
function letterIndex(letter){ return {A:0,B:1,C:2,D:3}[letter]; }
function toCSV(rows){
  const escape = v => '"' + String(v).replaceAll('"','""') + '"';
  const head = Object.keys(rows[0]);
  const lines = [head.join(',')].concat(rows.map(r=> head.map(k=>escape(r[k] ?? '')).join(',')));
  return lines.join('\n');
}
function formatMMSS(s){ const m = String(Math.floor(s/60)).padStart(2,'0'); const ss = String(s%60).padStart(2,'0'); return `${m}:${ss}`; }
function arraysEqual(a,b){ return Array.isArray(a) && Array.isArray(b) && a.length===b.length && a.every((v,i)=>v===b[i]); }
async function requestFullscreen(){ try{ const el = document.documentElement; if (el.requestFullscreen) await el.requestFullscreen(); }catch(e){} }

// ─────────────────────────────────────────────────────────────────────────────
// Estado y elementos
// ─────────────────────────────────────────────────────────────────────────────
const startBtn = $('#startBtn');
const goFull = $('#goFull');
const startCard = $('#startCard');
const quizRoot = $('#quizRoot');
const who = $('#who');
const progress = $('#progress');
const okCount = $('#okCount');
const badCount = $('#badCount');
const prevQ = $('#prevQ');
const nextQ = $('#nextQ');
const checkQ = $('#checkQ');
const timerEl = $('#timer');

let currentSet = [];
let questionCards = [];
let currentIndex = 0;
let timer = null;
let remaining = 240; // 4 minutos por pregunta

startBtn.addEventListener('click', () => {
  const name = $('#name').value.trim() || 'Anónimo';
  who.textContent = name;

  // Seleccionar 25 preguntas aleatorias del total
  currentSet = shuffle(MCQ.concat(ORDER)).slice(0,25);
  renderQuestions(currentSet);
  questionCards = $$('#questions .card');
  questionCards.forEach(c=> c.style.display='none');
  startCard.style.display = 'none';
  quizRoot.style.display = 'block';
  showIndex(0);
});

goFull.addEventListener('click', () => requestFullscreen());
prevQ.addEventListener('click', ()=> showIndex(currentIndex-1));
nextQ.addEventListener('click', ()=> showIndex(currentIndex+1));
checkQ.addEventListener('click', ()=> { checkCurrent(true); });
// Acciones globales
const exportBtnEl = document.getElementById('exportBtn');
if (exportBtnEl) exportBtnEl.addEventListener('click', exportCSV);
const resetBtnEl = document.getElementById('resetBtn');
if (resetBtnEl) resetBtnEl.addEventListener('click', () => location.reload());

function renderQuestions(items){
  const root = $('#questions');
  root.innerHTML = '';
  items.forEach((item, idx) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.qid = item.id;
    card.dataset.qtype = item.type;
    card.dataset.graded = '0';

    if (item.type === 'mcq'){
      const correctIdx = letterIndex(item.answer);
      const pairs = item.options.map((txt, i) => ({ txt, idx:i, correct: i===correctIdx }));
      const mixed = shuffle(pairs);
      card.innerHTML = `
        <div class="tag">MCQ · <span class="muted">${item.rule}</span></div>
        <div class="question">${idx+1}. ${item.question}</div>
        <div class="options allow-select"></div>
      `;
      const opts = card.querySelector('.options');
      mixed.forEach((o, k) => {
        const rid = `q${item.id}_${k}`;
        const row = document.createElement('label');
        row.className = 'option';
        row.innerHTML = `
          <input type="radio" name="q_${item.id}" id="${rid}" data-correct="${o.correct?1:0}">
          <span>${String.fromCharCode(65+k)}.</span>
          <span>${o.txt}</span>
        `;
        opts.appendChild(row);
      });
    }

    if (item.type === 'order'){
      const pieces = item.shuffled && item.shuffled.length ? item.shuffled.slice() : shuffle(item.correct_order.slice());
      const poolId = `pool_${item.id}`;
      const ansId = `ans_${item.id}`;
      card.innerHTML = `
        <div class="tag">Ordenar · <span class="muted">${item.rule}</span></div>
        <div class="question">${idx+1}. Toca las fichas para construir la oración correcta:</div>
        <div class="order-wrap">
          <div class="order-hint">Toca para <strong>añadir</strong> a tu respuesta. Vuelve a tocar en la respuesta para <strong>quitar</strong>. </div>
          <div class="order-areas">
            <div class="order-pool" id="${poolId}"></div>
            <div class="order-answer" id="${ansId}"><span class="ghost muted">Tu respuesta aquí…</span></div>
          </div>
        </div>
      `;
      const pool = card.querySelector('#'+CSS.escape(poolId));
      const ans = card.querySelector('#'+CSS.escape(ansId));
      pieces.forEach(t => pool.appendChild(makeChip(t)));

      const updateGhost = () => {
        const g = ans.querySelector('.ghost');
        if (g) g.style.display = ans.querySelectorAll('.order-chip').length ? 'none' : 'inline';
      };
      updateGhost();

      // Tapping
      card.addEventListener('click', (e) => {
        if (card.dataset.locked==='1') return;
        const chip = e.target.closest('.order-chip');
        if (!chip) return;
        const parent = chip.parentElement;
        if (parent === pool){ ans.appendChild(chip); }
        else if (parent === ans){ pool.appendChild(chip); }
        updateGhost();
      });
    }

    root.appendChild(card);
  });
}

function makeChip(text){
  const el = document.createElement('span');
  el.className = 'order-chip';
  el.innerHTML = `<span class="txt">${text}</span>`;
  return el;
}

function showIndex(i){
  if (!questionCards.length) return;
  i = Math.max(0, Math.min(i, questionCards.length-1));
  questionCards.forEach((c, k) => c.style.display = (k===i? 'block':'none'));
  currentIndex = i;
  progress.textContent = `${i+1}/25`;
  resetTimer();
  startTimer();
  window.scrollTo({ top:0, behavior:'smooth' });
}

function checkCurrent(showToast){
  const card = questionCards[currentIndex];
  if (!card) return;
  if (card.dataset.graded==='1') return; // ya calificada
  const type = card.dataset.qtype;
  card.classList.remove('correct','incorrect');
  let correct = false;

  if (type==='mcq'){
    const radios = Array.from(card.querySelectorAll('input[type="radio"]'));
    const chosen = radios.find(r=>r.checked);
    if (!chosen){ alert('Selecciona una opción.'); return; }
    correct = Number(chosen.dataset.correct)===1;
    radios.forEach(r=> r.disabled = true);
  } else {
    const ans = card.querySelector('.order-answer');
    const now = Array.from(ans.querySelectorAll('.txt')).map(t => t.textContent.trim());
    const qid = Number(card.dataset.qid);
    const q = ORDER.find(x=>x.id===qid);
    correct = q && arraysEqual(now, q.correct_order);
    // bloquear interacción tras comprobar
    card.dataset.locked = '1';
  }

  if (correct){ okCount.textContent = (+okCount.textContent+1); card.classList.add('correct'); if (showToast) toast('✅ Correcta'); }
  else { badCount.textContent = (+badCount.textContent+1); card.classList.add('incorrect'); if (showToast) toast('❌ Incorrecta'); }

  card.dataset.graded='1';
  stopTimer();
  // avanzar automático después de 1s
  setTimeout(()=>{
    if (currentIndex === questionCards.length-1){ finish(); }
    else { showIndex(currentIndex+1); }
  }, 900);
}

function finish(){
  // calcular nota 0.0 a 5.0
  const correct = +okCount.textContent;
  const grade = (correct/25)*5;
  const gradeFixed = grade.toFixed(1);
  const sum = document.createElement('div');
  sum.className='card';
  sum.innerHTML = `
    <div class="title" style="font-size:1.2rem;">Resultados</div>
    <p class="muted">Correctas: <strong>${correct}</strong> · Incorrectas: <strong>${+badCount.textContent}</strong></p>
    <p style="font-size:1.4rem; font-weight:800;">Nota final: <span style="background:linear-gradient(90deg,#22d3ee,#a78bfa); -webkit-background-clip:text; background-clip:text; color:transparent;">${gradeFixed}</span> / 5.0</p>
    <div class="footer" style="margin-top:8px;">
      <button class="btn warn" id="exportBtn2">Exportar CSV</button>
      <button class="btn secondary" onclick="location.reload()">Reiniciar</button>
    </div>
  `;
  const root = $('#questions');
  root.innerHTML = '';
  root.appendChild(sum);
  $('#exportBtn2').addEventListener('click', exportCSV);
}

function startTimer(){
  stopTimer();
  timer = setInterval(()=>{
    remaining -= 1;
    if (remaining <= 0){ timerEl.textContent = '00:00'; stopTimer(); autoFail(); }
    else { timerEl.textContent = formatMMSS(remaining); }
  }, 1000);
  timerEl.textContent = formatMMSS(remaining);
}
function resetTimer(){ remaining = 240; timerEl.textContent = '04:00'; }
function stopTimer(){ if (timer){ clearInterval(timer); timer=null; } }
function autoFail(){ // marcar como incorrecta y avanzar
  const card = questionCards[currentIndex];
  if (card && card.dataset.graded!=='1'){
    badCount.textContent = (+badCount.textContent+1);
    card.classList.add('incorrect');
    card.dataset.graded='1';
    toast('⏱️ Tiempo agotado');
  }
  setTimeout(()=>{ if (currentIndex === questionCards.length-1) finish(); else showIndex(currentIndex+1); }, 800);
}

// Export CSV considerando estado 1×1 (lee respuesta en .order-answer)
function exportCSV(){
  const name = $('#name') ? ($('#name').value.trim() || 'Anonimo') : 'Anonimo';
  const rows = [];
  // MCQ
  MCQ.forEach(q => {
    const group = $$(`input[name="q_${q.id}"]`);
    if (!group.length) return;
    const chosen = group.find(r => r.checked);
    const chosenTxt = chosen ? chosen.parentElement.querySelectorAll('span')[1].textContent : '';
    const correctIdx = letterIndex(q.answer);
    const correctTxt = q.options[correctIdx];
    const card = group[0].closest('.card');
    rows.push({ tipo:'MCQ', id:q.id, regla:q.rule, pregunta:q.question, respuesta_elegida:chosenTxt, respuesta_correcta:correctTxt, acierto: (card && card.dataset.graded==='1' && chosen && Number(chosen.dataset.correct)===1) ? '1':'0', participante:name });
  });
  // ORDER
  ORDER.forEach(q => {
    const ans = document.querySelector(`#ans_${q.id}`);
    if (!ans) return;
    const now = $(`#ans_${q.id}`) ? $$('#ans_'+q.id+' .txt').map(t => t.textContent.trim()) : [];
    const correct = q.correct_order.join(' ');
    const actual  = now.join(' ');
    const card = ans ? ans.closest('.card') : null;
    rows.push({ tipo:'ORDER', id:q.id, regla:q.rule, pregunta:'Ordena la oración', respuesta_elegida:actual, respuesta_correcta:correct, acierto: (card && card.dataset.graded==='1' && arraysEqual(now, q.correct_order))?'1':'0', participante:name });
  });
  if (!rows.length){ alert('No hay resultados que exportar.'); return; }
  const csv = toCSV(rows);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `resultados_gerunds_infinitives_${Date.now()}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// Seguridad — reinicio ante violaciones
let __breached = false;
function securityBreach(reason='Acción no permitida'){
  if (__breached) return; __breached = true;
  try{ stopTimer(); }catch(_){ }
  alert('Seguridad: '+reason+'\nLa evaluación se reiniciará.');
  location.reload();
}

window.addEventListener('contextmenu', e => { e.preventDefault(); securityBreach('context menu'); });
document.addEventListener('copy',  e => { e.preventDefault(); securityBreach('copiar'); });
document.addEventListener('cut',   e => { e.preventDefault(); securityBreach('cortar'); });
document.addEventListener('paste', e => { e.preventDefault(); securityBreach('pegar'); });

document.addEventListener('keydown', (e) => {
  const k = e.key.toLowerCase();
  const meta = (e.ctrlKey || e.metaKey);
  if (k === 'f12') { e.preventDefault(); e.stopPropagation(); return securityBreach('F12/DevTools'); }
  if (meta && e.shiftKey && ['i','c','j'].includes(k)) { e.preventDefault(); return securityBreach('DevTools'); }
  if (meta && k==='s') { e.preventDefault(); return securityBreach('Guardar forzado'); }
  if (k === 'printscreen') { e.preventDefault(); clearClipboard(); return securityBreach('PrintScreen'); }
}, true);

async function clearClipboard(){ try{ await navigator.clipboard.writeText(''); }catch(err){} }

document.addEventListener('visibilitychange', () => { if (document.hidden){ securityBreach('cambio de pestaña/ventana'); } });
window.addEventListener('blur', () => { securityBreach('pérdida de foco de la ventana'); });

// Toast
let toastTimer = null;
function toast(msg='Acción no permitida'){
  clearTimeout(toastTimer);
  let el = document.getElementById('toast');
  if (!el){ el = document.createElement('div'); el.id = 'toast'; el.style.position='fixed'; el.style.bottom='18px'; el.style.left='50%'; el.style.transform='translateX(-50%)'; el.style.background='rgba(2,6,23,.9)'; el.style.border='1px solid rgba(255,255,255,.15)'; el.style.backdropFilter='blur(6px)'; el.style.borderRadius='12px'; el.style.padding='8px 12px'; el.style.color='#fbbf24'; el.style.fontWeight='800'; el.style.zIndex='9999'; document.body.appendChild(el); }
  el.textContent = msg; el.style.opacity = '1';
  toastTimer = setTimeout(()=>{ el.style.opacity='0'; }, 1200);
}

// ─────────────────────────────────────────────────────────────────────────────
// DEV SELF‑TESTS (no modificar existentes; añadimos un par extra)
// ─────────────────────────────────────────────────────────────────────────────
(function devSelfTests(){
  const out = [];
  function ok(name, cond){ out.push(`${cond?'✔':'✘'} ${name}`); if(!cond) console.error('Test failed:', name); }
  try{
    // EXISTENTES
    const csv = toCSV([{a:1,b:'x"y'},{a:2,b:'a,b'}]);
    const lines = csv.split('\n');
    ok('toCSV has >= 3 lines', lines.length >= 3);
    ok('toCSV header a,b', lines[0] === 'a,b');
    ok('toCSV row1 quotes embedded " correctly', lines[1] === '"1","x""y"');
    ok('toCSV row2 keeps comma inside quotes', lines[2] === '"2","a,b"');

    ok('formatMMSS(240) == 04:00', formatMMSS(240)==='04:00');
    ok('formatMMSS(61) == 01:01', formatMMSS(61)==='01:01');

    const arr = [1,2,3,4];
    const s = shuffle(arr.slice());
    ok('shuffle length preserved', s.length===arr.length);
    ok('shuffle same set', arr.slice().sort().join(',')===s.slice().sort().join(','));

    ok('arraysEqual positive', arraysEqual([1,2],[1,2])===true);
    ok('arraysEqual negative', arraysEqual([1,2],[2,1])===false);

    // NUEVOS: comprobación de salto de línea en CSV y disponibilidad de FS
    const csvNL = toCSV([{a:'line1\nline2',b:'ok'}]);
    ok('toCSV preserves newline inside quotes', /"line1\nline2","ok"/.test(csvNL));
    ok('requestFullscreen exists', typeof requestFullscreen === 'function');
  }catch(e){ console.error('Self-tests threw:', e); out.push('✘ self-tests threw: '+e.message); }
  const pre = document.getElementById('dev-tests');
  if (pre) pre.textContent = out.join('\n');
})();
  </script>
</body>
</html>
